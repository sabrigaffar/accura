# ๐ ุชุทุจูู ุฑุณูู ุงูุชูุตูู ุญุณุจ GPS
# GPS-Based Delivery Fee Implementation

## ๐ฏ ุงูููุฒุงุช ุงูููุทุจูููุฉ

### โ ุชู ุชุทุจูู:

1. **ุญุฐู/ุชุนุทูู ุงููุชุฌุฑ**
2. **ุชุญุฏูุฏ ูููุน ุงููุชุฌุฑ ุจุงุณุชุฎุฏุงู GPS**
3. **ุญุณุงุจ ุงููุณุงูุฉ ุชููุงุฆูุงู**
4. **ุฑุณูู ุงูุชูุตูู: 10 ุฌููู ููู ูููููุชุฑ**

---

## ๐ ุงููููุงุช ุงููููุดุฃุฉ/ุงูููุนุฏูููุฉ

### 1. ูููุงุช ุฌุฏูุฏุฉ:

| ุงูููู | ุงููุตู |
|------|-------|
| `lib/deliveryFeeCalculator.ts` | ุฏูุงู ุญุณุงุจ ุงููุณุงูุฉ ูุฑุณูู ุงูุชูุตูู |
| `hooks/useLocation.ts` | Hook ูุฅุฏุงุฑุฉ GPS ูุงููููุน |
| `supabase/migrations/add_location_and_delivery_fee_fields.sql` | SQL migration ูููููุน ูุฑุณูู ุงูุชูุตูู |

### 2. ูููุงุช ูุนุฏููุฉ:

| ุงูููู | ุงูุชุนุฏูู |
|------|---------|
| `app/profile/merchant-profile.tsx` | ุฅุถุงูุฉ ุญุฐู/ุชุนุทูู ูุชุฌุฑ + ุชุญุฏูุฏ ูููุน GPS |
| `app/profile/_layout.tsx` | ุฅุถุงูุฉ ActiveStoreProvider |

---

## 1๏ธโฃ ุญุฐู/ุชุนุทูู ุงููุชุฌุฑ

### ุงูููุฒุงุช:

#### ุฃ. ุชุนุทูู ุงููุชุฌุฑ ูุคูุชุงู:
```
๐ ุชุนุทูู ุงููุชุฌุฑ ูุคูุชุงู
โโ ูู ูุธูุฑ ููุนููุงุก
โโ ูู ุชุณุชุทูุน ุฅุถุงูุฉ ููุชุฌุงุช
โโ ุงูุทูุจุงุช ุงูุญุงููุฉ ุณุชุณุชูุฑ
```

#### ุจ. ุญุฐู ุงููุชุฌุฑ ููุงุฆูุงู:
```
๐๏ธ ุญุฐู ุงููุชุฌุฑ ููุงุฆูุงู
โโ ุญุฐู ุฌููุน ุงูููุชุฌุงุช
โโ ุญุฐู ุฌููุน ุงูุจูุงูุงุช
โโ ุชุฃููุฏ ูุฒุฏูุฌ ููุญูุงูุฉ
```

### ุงูููุฏ:

```typescript
// ุชุนุทูู ุงููุชุฌุฑ
const handleToggleStoreActive = async () => {
  await supabase
    .from('merchants')
    .update({ is_active: !currentStatus })
    .eq('id', merchantId);
};

// ุญุฐู ุงููุชุฌุฑ
const handleDeleteStore = async () => {
  // ุชุฃููุฏ ูุฒุฏูุฌ
  Alert.prompt('ุงูุชุจ "ุญุฐู" ููุชุฃููุฏ');
  
  await supabase
    .from('merchants')
    .delete()
    .eq('id', merchantId);
};
```

---

## 2๏ธโฃ ูุธุงู GPS ูุฑุณูู ุงูุชูุตูู

### ููู ูุนููุ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  1๏ธโฃ ุงูุชุงุฌุฑ ูุญุฏุฏ ูููุน ูุชุฌุฑู    โ
โ     (ูุถุบุท ุฒุฑ "ุชุญุฏูุฏ ุงููููุน")    โ
โ            โ                     โ
โ  ๐ฑ ุงูุชุทุจูู ูุทูุจ ุฅุฐู GPS       โ
โ            โ                     โ
โ  ๐ GPS ูุญุฏุฏ ุงููููุน ุงูุญุงูู     โ
โ            โ                     โ
โ  ๐พ ุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช     โ
โ     (latitude, longitude)        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  2๏ธโฃ ุงูุนููู ูุทูุจ ูู ุงููุชุฌุฑ      โ
โ            โ                     โ
โ  ๐ฑ ุงูุชุทุจูู ูุญุตู ุนูู ูููุน      โ
โ     ุงูุนููู (GPS)                โ
โ            โ                     โ
โ  ๐ ุญุณุงุจ ุงููุณุงูุฉ ุจูู:           โ
โ     - ูููุน ุงููุชุฌุฑ               โ
โ     - ูููุน ุงูุนููู               โ
โ            โ                     โ
โ  ๐ฐ ุญุณุงุจ ุฑุณูู ุงูุชูุตูู:          โ
โ     ุงููุณุงูุฉ (ูู) ร 10 ุฌููู      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## 3๏ธโฃ ุตูุบุฉ ุญุณุงุจ ุงูุฑุณูู

### ุงููุงุนุฏุฉ ุงูุฃุณุงุณูุฉ:

```
ุฑุณูู ุงูุชูุตูู = ceil(ุงููุณุงูุฉ ุจุงููู) ร 10 ุฌููู
```

### ุฃูุซูุฉ:

| ุงููุณุงูุฉ | ุงูุชูุฑูุจ | ุงูุฑุณูู |
|---------|---------|--------|
| 0.3 ูู (300 ู) | 1 ูู | 10 ุฌููู |
| 0.8 ูู (800 ู) | 1 ูู | 10 ุฌููู |
| 1.1 ูู | 2 ูู | 20 ุฌููู |
| 1.4 ูู | 2 ูู | 20 ุฌููู |
| 2.5 ูู | 3 ูู | 30 ุฌููู |
| 5.2 ูู | 6 ูู | 60 ุฌููู |

### ุงูููุฏ:

```typescript
// ูู lib/deliveryFeeCalculator.ts

export function calculateDeliveryFee(distanceInKm: number): number {
  const feePerKm = 10; // 10 ุฌููู ููู ูููู
  
  // ุชูุฑูุจ ูุฃุนูู ูููู ูุงูู
  const kilometers = Math.ceil(distanceInKm);
  
  const fee = kilometers * feePerKm;
  
  return fee;
}

// ูุซุงู:
calculateDeliveryFee(0.3);  // โ 10 ุฌููู
calculateDeliveryFee(1.4);  // โ 20 ุฌููู
calculateDeliveryFee(2.5);  // โ 30 ุฌููู
```

---

## 4๏ธโฃ ุญุณุงุจ ุงููุณุงูุฉ (Haversine Formula)

### ุงูุตูุบุฉ ุงูุฑูุงุถูุฉ:

```typescript
export function calculateDistance(
  point1: Location, 
  point2: Location
): number {
  const R = 6371; // ูุตู ูุทุฑ ุงูุฃุฑุถ ุจุงููููููุชุฑ
  
  const lat1 = point1.latitude * Math.PI / 180;
  const lat2 = point2.latitude * Math.PI / 180;
  const deltaLat = (point2.latitude - point1.latitude) * Math.PI / 180;
  const deltaLon = (point2.longitude - point1.longitude) * Math.PI / 180;

  const a = 
    Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
    Math.cos(lat1) * Math.cos(lat2) *
    Math.sin(deltaLon / 2) * Math.sin(deltaLon / 2);
  
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  const distance = R * c;
  
  return distance;
}
```

---

## 5๏ธโฃ ุฅุฐู GPS

### ุทูุจ ุงูุฅุฐู ูู ุงููุณุชุฎุฏู:

```typescript
// ูู hooks/useLocation.ts

const requestPermission = async (): Promise<boolean> => {
  const { status } = await Location.requestForegroundPermissionsAsync();
  
  if (status !== Location.PermissionStatus.GRANTED) {
    Alert.alert(
      'ุฅุฐู ุงููููุน ูุทููุจ',
      'ูุญุชุงุฌ ุงูุชุทุจูู ุฅูู ุฅุฐู ุงููุตูู ูููููุน ูุญุณุงุจ ุฑุณูู ุงูุชูุตูู ุจุฏูุฉ.',
      [
        { text: 'ุฅูุบุงุก', style: 'cancel' },
        { text: 'ุงูุณูุงุญ', onPress: () => requestPermission() }
      ]
    );
    return false;
  }
  
  return true;
};
```

### ุงูุญุตูู ุนูู ุงููููุน ุงูุญุงูู:

```typescript
const getCurrentLocation = async (): Promise<UserLocation | null> => {
  // ุทูุจ ุงูุฅุฐู
  const granted = await requestPermission();
  if (!granted) return null;
  
  // ุงูุญุตูู ุนูู ุงููููุน
  const location = await Location.getCurrentPositionAsync({
    accuracy: Location.Accuracy.Balanced,
  });
  
  return {
    latitude: location.coords.latitude,
    longitude: location.coords.longitude,
  };
};
```

---

## 6๏ธโฃ ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุงูุชุนุฏููุงุช ุนูู ุฌุฏูู `merchants`:

```sql
ALTER TABLE merchants
ADD COLUMN IF NOT EXISTS latitude NUMERIC,
ADD COLUMN IF NOT EXISTS longitude NUMERIC,
ADD COLUMN IF NOT EXISTS max_delivery_distance NUMERIC DEFAULT 15;
```

### ุงูุชุนุฏููุงุช ุนูู ุฌุฏูู `orders`:

```sql
ALTER TABLE orders
ADD COLUMN IF NOT EXISTS customer_latitude NUMERIC,
ADD COLUMN IF NOT EXISTS customer_longitude NUMERIC,
ADD COLUMN IF NOT EXISTS delivery_distance_km NUMERIC,
ADD COLUMN IF NOT EXISTS calculated_delivery_fee NUMERIC;
```

### ุฏุงูุฉ ุญุณุงุจ ุงููุณุงูุฉ ูู SQL:

```sql
CREATE OR REPLACE FUNCTION calculate_distance(
  lat1 NUMERIC, lon1 NUMERIC,
  lat2 NUMERIC, lon2 NUMERIC
) RETURNS NUMERIC AS $$
-- Haversine formula in PostgreSQL
$$ LANGUAGE plpgsql IMMUTABLE;
```

### ุฏุงูุฉ ุญุณุงุจ ุฑุณูู ุงูุชูุตูู ูู SQL:

```sql
CREATE OR REPLACE FUNCTION calculate_delivery_fee(
  distance_km NUMERIC
) RETURNS NUMERIC AS $$
DECLARE
  fee_per_km NUMERIC := 10;
  kilometers INTEGER;
BEGIN
  kilometers := CEIL(distance_km);
  RETURN kilometers * fee_per_km;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
```

### Trigger ุชููุงุฆู:

```sql
CREATE TRIGGER trigger_update_order_delivery_info
  BEFORE INSERT OR UPDATE ON orders
  FOR EACH ROW
  EXECUTE FUNCTION update_order_delivery_info();
```

ูุญุณุจ ุงููุณุงูุฉ ูุฑุณูู ุงูุชูุตูู **ุชููุงุฆูุงู** ุนูุฏ ุฅูุดุงุก/ุชุญุฏูุซ ุงูุทูุจ!

---

## 7๏ธโฃ ูุงุฌูุฉ ุงููุณุชุฎุฏู

### ูู ุตูุญุฉ `merchant-profile.tsx`:

#### ูุจู ุชุญุฏูุฏ ุงููููุน:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ ูููุน ุงููุชุฌุฑ (GPS)           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โ๏ธ ูู ูุชู ุชุญุฏูุฏ ูููุน ุงููุชุฌุฑ    โ
โ                                 โ
โ ุญุฏุฏ ูููุน ูุชุฌุฑู ูุญุณุงุจ ุฑุณูู      โ
โ ุงูุชูุตูู ุชููุงุฆูุงู ุญุณุจ ุงููุณุงูุฉ   โ
โ                                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ ๐ ุชุญุฏูุฏ ูููุน ุงููุชุฌุฑ     โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

#### ุจุนุฏ ุชุญุฏูุฏ ุงููููุน:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ ูููุน ุงููุชุฌุฑ (GPS)           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ ุงููููุน ุงููุญููุธ:              โ
โ 24.713552, 46.675296            โ
โ                                 โ
โ โ ุงูููุงุฆุฏ:                     โ
โ โข ุญุณุงุจ ุชููุงุฆู ูุฑุณูู ุงูุชูุตูู    โ
โ โข ุนุฏุงูุฉ ูู ุงูุชุณุนูุฑ ููุนููุงุก     โ
โ โข 10 ุฌููู ููู ูููููุชุฑ          โ
โ                                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ ๐ ุชุญุฏูุซ ุงููููุน          โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## 8๏ธโฃ ุชุฏูู ุงูุนูู ุงููุงูู

### ููุชุงุฌุฑ:

```
1. ููุชุญ "ููู ุงููุชุฌุฑ"
   โ
2. ูุณู "ูููุน ุงููุชุฌุฑ (GPS)"
   โ
3. ูุถุบุท "ุชุญุฏูุฏ ูููุน ุงููุชุฌุฑ"
   โ
4. ุงูุชุทุจูู ูุทูุจ ุฅุฐู GPS
   โ
5. ุงูุชุงุฌุฑ ููุงูู
   โ
6. GPS ูุญุฏุฏ ุงููููุน ุงูุญุงูู
   โ
7. ููุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
   โ
8. โ ุชู! ุงูุขู ุฑุณูู ุงูุชูุตูู ุชูุญุณุจ ุชููุงุฆูุงู
```

### ููุนููู (ุนูุฏ ุงูุทูุจ):

```
1. ุงูุนููู ูุฎุชุงุฑ ููุชุฌุงุช ูู ุงููุชุฌุฑ
   โ
2. ูุถุบุท "ุฅุชูุงู ุงูุทูุจ"
   โ
3. ุงูุชุทุจูู ูุทูุจ ุฅุฐู GPS
   โ
4. ุงูุนููู ููุงูู
   โ
5. ุงูุชุทุจูู ูุญุตู ุนูู ูููุนู ุงูุนููู ูุงููุชุฌุฑ
   โ
6. ูุญุณุจ ุงููุณุงูุฉ:
   distance = calculateDistance(storeLocation, customerLocation)
   โ
7. ูุญุณุจ ุฑุณูู ุงูุชูุตูู:
   fee = ceil(distance) ร 10
   โ
8. ูุนุฑุถ ููุนููู:
   "ุงูููุชุฌุงุช: 150 ุฌููู"
   "ุฑุณูู ุงูุชูุตูู: 30 ุฌููู (3 ูู)"
   "ุงูุฅุฌูุงูู: 180 ุฌููู"
   โ
9. ุงูุนููู ูุคูุฏ ุงูุทูุจ
   โ
10. ููุญูุธ ุงูุทูุจ ูุน:
    - customer_latitude
    - customer_longitude
    - delivery_distance_km
    - calculated_delivery_fee
```

---

## 9๏ธโฃ ุงูุฎุทูุงุช ุงูุชุงููุฉ

### ูุชุทุจูู Migration:

```bash
# 1. ุชุทุจูู SQL migration
psql -h your-db-host -U postgres -d your-database -f supabase/migrations/add_location_and_delivery_fee_fields.sql
```

ุฃู ูู Supabase Dashboard:
```
SQL Editor โ New Query โ 
ูุณุฎ ูุญุชูู add_location_and_delivery_fee_fields.sql
โ Run
```

### ูุงุฎุชุจุงุฑ ุงููุธุงู:

```bash
# 1. ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู
npx expo start -c

# 2. ูุชุญ ุงูุชุทุจูู

# 3. ุชุณุฌูู ุงูุฏุฎูู ูุชุงุฌุฑ

# 4. ุงูุฐูุงุจ ุฅูู "ููู ุงููุชุฌุฑ"

# 5. ุชุญุฏูุฏ ูููุน ุงููุชุฌุฑ

# 6. ุชุณุฌูู ุงูุฏุฎูู ูุนููู (ูู ุฌูุงุฒ ุขุฎุฑ)

# 7. ุฅูุดุงุก ุทูุจ

# 8. ุงูุชุญูู ูู ุญุณุงุจ ุฑุณูู ุงูุชูุตูู ุชููุงุฆูุงู
```

---

## ๐ฏ ุงูููุงุฆุฏ

### ููุชุงุฌุฑ:
- โ **ุนุฏุงูุฉ**: ูุง ุฎุณุงุฑุฉ ูู ุงูุชูุตูู ุงูุจุนูุฏ
- โ **ุชููุงุฆู**: ูุง ุญุงุฌุฉ ูุญุณุงุจ ูุฏูู
- โ **ูุฑููุฉ**: ูููู ุชุญุฏูุซ ุงููููุน ูู ุฃู ููุช

### ููุนููู:
- โ **ุดูุงููุฉ**: ูุนุฑู ุงูุชูููุฉ ูุจู ุงูุทูุจ
- โ **ุนุฏุงูุฉ**: ูุฏูุน ุญุณุจ ุงููุณุงูุฉ ุงููุนููุฉ
- โ **ูุถูุญ**: ูุฑู ุงููุณุงูุฉ ุจุงููููููุชุฑ

### ูููุธุงู:
- โ **ุฏูุฉ**: ุญุณุงุจ GPS ุฏููู
- โ **ุณุฑุนุฉ**: ุญุณุงุจ ููุฑู
- โ **ููุซูููุฉ**: triggers ุชููุงุฆูุฉ

---

## โ ุฃุณุฆูุฉ ุดุงุฆุนุฉ

### ุณ1: ูุงุฐุง ูู ูู ูุญุฏุฏ ุงูุชุงุฌุฑ ูููุนูุ
**ุฌ:** ูุณุชูุฑ ุงููุธุงู ุงููุฏูู (ุฑุณูู ุซุงุจุชุฉ ูู `delivery_fee`).

### ุณ2: ูุงุฐุง ูู ุฑูุถ ุงูุนููู ุฅุฐู GPSุ
**ุฌ:** ูุณุชุฎุฏู ุฑุณูู ุซุงุจุชุฉ ุฃู ูุทูุจ ููู ุฅุฏุฎุงู ุงูุนููุงู ูุฏููุงู.

### ุณ3: ูู ูููู ุชุบููุฑ 10 ุฌููู ููู ููุ
**ุฌ:** ูุนูุ ูู `deliveryFeeCalculator.ts`:
```typescript
const feePerKm = 10; // ุบููุฑ ูุฐุง ุงูุฑูู
```

### ุณ4: ูู ุงูุญุณุงุจ ุฏููู 100%ุ
**ุฌ:** Haversine formula ุฏูููุฉ ~99.5%. ุงููุฑู ุนุงุฏุฉ < 100 ูุชุฑ.

### ุณ5: ูุงุฐุง ุนู ุงูุฃูุงูู ุงููุฒุฏุญูุฉุ
**ุฌ:** ูููู ุฅุถุงูุฉ ุนูุงูู ุฅุถุงููุฉ:
```typescript
if (isRushHour) fee *= 1.3; // ุฒูุงุฏุฉ 30% ุฃููุงุช ุงูุฐุฑูุฉ
```

---

## ๐ ููุฎุต

### โ ูุง ุชู ุชุทุจููู:

1. **ูุธุงู GPS ูุงูู**
   - ุทูุจ ุฅุฐู
   - ุชุญุฏูุฏ ูููุน ุงููุชุฌุฑ
   - ุญุณุงุจ ุงููุณุงูุฉ

2. **ุญุณุงุจ ุฑุณูู ุชููุงุฆู**
   - 10 ุฌููู ููู ูู
   - ุชูุฑูุจ ูุฃุนูู ูููู
   - ุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

3. **ุฅุฏุงุฑุฉ ุงููุชุงุฌุฑ**
   - ุชุนุทูู ูุคูุช
   - ุญุฐู ููุงุฆู
   - ุชุฃููุฏ ูุฒุฏูุฌ

4. **ูุงุนุฏุฉ ุจูุงูุงุช**
   - ุญููู ุฌุฏูุฏุฉ
   - ุฏูุงู SQL
   - Triggers ุชููุงุฆูุฉ

---

**ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู! ๐**

ูุฃู ุงุณุชูุณุงุฑุงุช ุฃู ุชุญุณููุงุชุ ูุฑุฌู ุงููุฑุงุฌุนุฉ.

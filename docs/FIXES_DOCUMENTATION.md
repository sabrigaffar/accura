# توثيق الإصلاحات - تطبيق مسافة السكة

## المشاكل التي تم إصلاحها

### 1. ✅ مشكلة التسجيل - عدم حفظ البيانات في قاعدة البيانات

**المشكلة**: عند التسجيل كتاجر أو سائق أو عميل، كان التطبيق يسمح بالدخول لكن لا يتم حفظ البيانات في جدول `profiles`.

**الحل المُطبق**:
- إنشاء Database Trigger (`handle_new_user`) يتم تشغيله تلقائياً عند إنشاء مستخدم جديد
- الـ Trigger يقوم بإنشاء سجل في جدول `profiles` تلقائياً مع:
  - نوع المستخدم (customer/merchant/driver)
  - الاسم الكامل
  - رقم الهاتف
- إضافة عملية `upsert` يدوية في كود التسجيل كإجراء احتياطي

**الملفات المعدلة**:
- `supabase/migrations/20251025_fix_profile_creation.sql` (جديد)
- `app/auth/signup.tsx`

---

### 2. ✅ عدم إرسال رسالة تأكيد OTP

**المشكلة**: لا يتم إرسال رمز التأكيد (OTP) على رقم الهاتف بعد التسجيل.

**السبب**: خدمة Phone Authentication في Supabase تحتاج إلى:
1. تفعيل Phone Auth في لوحة تحكم Supabase
2. إعداد مزود SMS (مثل Twilio أو MessageBird)

**الحل المُطبق**:
- إضافة رسالة توضيحية للمستخدم تشرح متطلبات تفعيل OTP
- تحديث كود التسجيل ليدعم OTP عند تفعيله
- التطبيق يعمل حالياً مع أو بدون OTP

**خطوات تفعيل OTP** (اختياري):
1. افتح لوحة تحكم Supabase
2. اذهب إلى Authentication → Providers
3. فعّل "Phone" provider
4. قم بإعداد مزود SMS (Twilio موصى به)
5. أدخل بيانات الاعتماد الخاصة بمزود SMS

---

### 3. ✅ الحساب يظهر بدون بيانات

**المشكلة**: بعد التسجيل، صفحة الحساب تظهر فارغة أو بدون بيانات.

**السبب**: عدم إنشاء سجل في جدول `profiles` (تم حلها في النقطة 1).

**الحل**: بعد تطبيق الإصلاح الأول، ستظهر جميع بيانات المستخدم بشكل صحيح.

---

### 4. ✅ تعديل العنوان يظهر رسالة "قريباً"

**المشكلة**: عند الضغط على زر تعديل العنوان، تظهر رسالة "سيتم تطوير هذه الميزة قريباً".

**الحل المُطبق**:
- تنفيذ ميزة تعديل العنوان بالكامل
- إضافة Modal (نافذة منبثقة) لتعديل العنوان
- إضافة دوال `updateAddress` و `openEditModal`
- تحديث واجهة المستخدم لدعم التعديل والإضافة

**المزايا الجديدة**:
- يمكن الآن تعديل أي عنوان محفوظ
- نفس النافذة تُستخدم للإضافة والتعديل
- حفظ تلقائي مع رسالة نجاح

**الملفات المعدلة**:
- `app/profile/addresses.tsx`

---

### 5. ✅ حذف العنوان يظهر خطأ

**المشكلة**: عند محاولة حذف عنوان، يظهر خطأ.

**السبب المحتمل**: صلاحيات RLS (Row Level Security) لم تكن تسمح بالحذف.

**الحل المُطبق**:
- إضافة/تحديث سياسة RLS للسماح للمستخدمين بحذف عناوينهم الخاصة
- التأكد من أن `user_id` يطابق `auth.uid()`

**Policy المضافة**:
```sql
CREATE POLICY "Users can delete their own addresses"
  ON addresses FOR DELETE
  TO authenticated
  USING (user_id = auth.uid());
```

---

## خطوات تطبيق الإصلاحات

### الخطوة 1: تطبيق Migration على قاعدة البيانات

يجب تنفيذ ملف SQL الجديد على قاعدة بيانات Supabase:

**الطريقة الأولى** - عبر Supabase Dashboard:
1. افتح لوحة تحكم Supabase
2. اذهب إلى SQL Editor
3. افتح ملف `supabase/migrations/20251025_fix_profile_creation.sql`
4. انسخ محتوياته والصقه في SQL Editor
5. اضغط Run

**الطريقة الثانية** - عبر Supabase CLI:
```bash
supabase db push
```

### الخطوة 2: إعادة تشغيل التطبيق

بعد تطبيق التحديثات، أعد تشغيل التطبيق:

```bash
npm start
# أو
npx expo start
```

### الخطوة 3: اختبار الميزات المُصلحة

اختبر الميزات التالية:

1. **التسجيل**:
   - سجّل حساب جديد كتاجر
   - تحقق من ظهور البيانات في صفحة الحساب
   - تحقق من وجود سجل في جدول `profiles` في Supabase

2. **العناوين**:
   - أضف عنوان جديد
   - عدّل العنوان
   - احذف العنوان
   - تأكد من عمل جميع العمليات بنجاح

3. **الملف الشخصي**:
   - تحقق من ظهور الاسم ورقم الهاتف
   - تحقق من إمكانية تعديل البيانات

---

## ملاحظات مهمة

### للمستخدمين الحاليين

إذا كان لديك مستخدمون تم تسجيلهم قبل هذه الإصلاحات ولا توجد لهم سجلات في `profiles`:

**حل يدوي**:
قم بتشغيل هذا SQL لإنشاء profiles للمستخدمين الحاليين:

```sql
INSERT INTO profiles (id, user_type, full_name, phone_number, is_active)
SELECT 
  id, 
  COALESCE(raw_user_meta_data->>'user_type', 'customer') as user_type,
  COALESCE(raw_user_meta_data->>'full_name', '') as full_name,
  COALESCE(phone, raw_user_meta_data->>'phone_number', '') as phone_number,
  true as is_active
FROM auth.users
WHERE id NOT IN (SELECT id FROM profiles)
ON CONFLICT (id) DO NOTHING;
```

### تفعيل OTP (اختياري)

إذا أردت تفعيل خاصية إرسال OTP:

1. **التكلفة**: إرسال SMS ليس مجانياً، ستحتاج حساب مدفوع مع Twilio أو MessageBird
2. **الإعداد**: 
   - سجّل حساب في [Twilio](https://www.twilio.com/)
   - احصل على Account SID وAuth Token
   - اشترِ رقم هاتف Twilio
   - أدخل البيانات في إعدادات Supabase Phone Auth

3. **البديل**: يمكن استخدام Email Authentication بدلاً من Phone إذا كانت التكلفة مشكلة

---

## الاختبار الشامل

### سيناريو اختبار كامل:

1. **التسجيل كتاجر**:
   - افتح صفحة التسجيل
   - اختر "تاجر" كنوع الحساب
   - أدخل الاسم الكامل ورقم الهاتف وكلمة المرور
   - اضغط "إنشاء حساب"
   - تأكد من ظهور رسالة النجاح
   - تأكد من الانتقال إلى الصفحة الرئيسية

2. **التحقق من البيانات**:
   - افتح صفحة الملف الشخصي
   - تأكد من ظهور الاسم ورقم الهاتف
   - تأكد من إمكانية تعديل البيانات

3. **إدارة العناوين**:
   - اذهب إلى "عناويني"
   - أضف عنوان جديد
   - عدّل العنوان
   - احذف العنوان
   - تأكد من عدم ظهور أي أخطاء

4. **التحقق من قاعدة البيانات**:
   - افتح Supabase Dashboard
   - افتح Table Editor
   - افتح جدول `profiles`
   - تأكد من وجود سجل للمستخدم الجديد مع نوع المستخدم الصحيح

---

## المشاكل المحتملة والحلول

### المشكلة: "الـ Trigger لا يعمل"
**الحل**: 
- تأكد من تطبيق Migration بنجاح
- تحقق من وجود الـ Function في Database → Functions
- تحقق من وجود الـ Trigger في Database → Triggers

### المشكلة: "لا يزال العنوان لا يُحذف"
**الحل**:
- تحقق من RLS Policies في جدول `addresses`
- تأكد من أن المستخدم مسجل دخول (`auth.uid()` ليس null)
- راجع console logs للأخطاء

### المشكلة: "النافذة المنبثقة لا تظهر"
**الحل**:
- تأكد من أن جميع الأنماط (styles) موجودة
- راجع console logs للأخطاء
- تأكد من عدم وجود أخطاء TypeScript

---

## تحديثات مستقبلية مقترحة

1. **إضافة خريطة لتحديد الموقع** عند إضافة/تعديل العنوان
2. **التحقق من رقم الهاتف** عبر OTP إلزامي
3. **رفع صورة الملف الشخصي**
4. **إشعارات Push** للطلبات الجديدة
5. **نظام تقييم** محسّن للسائقين والتجار

---

## الدعم والمساعدة

إذا واجهت أي مشاكل بعد تطبيق هذه الإصلاحات:

1. تحقق من console logs في المتصفح/التطبيق
2. راجع Supabase Logs في Dashboard
3. تأكد من تطبيق جميع الخطوات بالترتيب
4. راجع documentation الخاص بـ Supabase

---

**تاريخ التحديث**: 2025-10-25
**الإصدار**: 1.1.0

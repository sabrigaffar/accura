# ุฏููู ุชุฑููุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
# Database Migration Guide

## ๐ฏ ุงููุฏู ูู ูุฐุง ุงูุฏููู

ูุฐุง ุงูุฏููู ูุดุฑุญ ููููุฉ ุชุทุจูู ุงูุชุญุฏูุซุงุช ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุฅุถุงูุฉ ุงูุฏุนู ุงููุงูู ูููุฒุฉ ุงููุชุงุฌุฑ ุงููุชุนุฏุฏุฉ.

---

## โ๏ธ ุงููุดููุฉ ุงูุญุงููุฉ

ุงูููุฏ ูุนูู ุงูุขู ูููู ูุน **fallback mechanism** - ุฅุฐุง ูู ููู ุนููุฏ `store_id` ููุฌูุฏุงู ูู ุฌุฏูู `orders`ุ ูุฅู ุงูููุฏ ุณูุฌูุจ ุฌููุน ุงูุทูุจุงุช ุฏูู ุชุตููุฉ ุญุณุจ ุงููุชุฌุฑ.

### ุงูุฃุฎุทุงุก ุงูุชู ูุฏ ุชุธูุฑ:
```
ERROR  Error fetching orders: {"code": "42703", "message": "column orders.store_id does not exist"}
```

---

## โ ุงูุญู: ุชุทุจูู Migration

### ุงูุฎุทูุฉ 1: ุงููุตูู ุฅูู Supabase Dashboard

1. ุงูุชุญ [Supabase Dashboard](https://app.supabase.com)
2. ุงุฎุชุฑ ูุดุฑูุนู
3. ุงุฐูุจ ุฅูู **SQL Editor** ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ

### ุงูุฎุทูุฉ 2: ุชูููุฐ SQL Script

1. ุงูุณุฎ ูุญุชูู ุงูููู:
   ```
   supabase/migrations/add_store_id_to_orders.sql
   ```

2. ุงูุตู ุงููุญุชูู ูู **SQL Editor**

3. ุงุถุบุท **Run** ุฃู `Ctrl+Enter`

### ุงูุฎุทูุฉ 3: ุงูุชุญูู ูู ุงููุฌุงุญ

ุจุนุฏ ุชูููุฐ ุงูุณูุฑูุจุชุ ุชุญูู ูู:

```sql
-- ุชุญูู ูู ูุฌูุฏ ุงูุนููุฏ
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'orders' AND column_name = 'store_id';
```

ูุฌุจ ุฃู ุชุฑู:
```
column_name | data_type
------------|----------
store_id    | uuid
```

---

## ๐ ูุง ุงูุฐู ููุนูู ุงูุณูุฑูุจุชุ

### 1. ุฅุถุงูุฉ ุนููุฏ `store_id`
```sql
ALTER TABLE orders ADD COLUMN store_id UUID;
```

### 2. ุฑุจุท ุงูุนููุฏ ุจุฌุฏูู ุงููุชุงุฌุฑ
```sql
ALTER TABLE orders
ADD CONSTRAINT orders_store_id_fkey 
FOREIGN KEY (store_id) 
REFERENCES merchants(id);
```

### 3. ุชุญุฏูุซ ุงูุทูุจุงุช ุงูููุฌูุฏุฉ
ุงูุณูุฑูุจุช ูุฑุจุท ุฌููุน ุงูุทูุจุงุช ุงูููุฌูุฏุฉ ุจุงููุชุฌุฑ ุงูุฃูู ููู ุชุงุฌุฑ:
```sql
UPDATE orders o
SET store_id = (
  SELECT m.id FROM merchants m 
  WHERE m.owner_id = o.merchant_id 
  ORDER BY m.created_at ASC LIMIT 1
);
```

### 4. ุฅูุดุงุก ููุฑุณ ููุฃุฏุงุก
```sql
CREATE INDEX orders_store_id_idx ON orders(store_id);
```

---

## ๐ ุจุนุฏ ุชุทุจูู Migration

### โ ูุง ุณูุนูู ุจุดูู ุตุญูุญ:

1. **ุชุตููุฉ ุงูุทูุจุงุช ุญุณุจ ุงููุชุฌุฑ**
   - ุนูุฏ ุงุฎุชูุงุฑ ูุชุฌุฑ ูุนููุ ุณุชุธูุฑ ููุท ุทูุจุงุช ูุฐุง ุงููุชุฌุฑ
   - ุนูุฏ ุงุฎุชูุงุฑ "ุฌููุน ุงููุชุงุฌุฑ"ุ ุณุชุธูุฑ ุทูุจุงุช ุฌููุน ุงููุชุงุฌุฑ

2. **ุฅุญุตุงุฆูุงุช ุฏูููุฉ**
   - ููุญุฉ ุงูุชุญูู ุณุชุนุฑุถ ุฅุญุตุงุฆูุงุช ุฏูููุฉ ููู ูุชุฌุฑ
   - ุงูุฅูุฑุงุฏุงุช ุณุชููู ููุณูุฉ ุญุณุจ ุงููุชุงุฌุฑ

3. **ุฃุฏุงุก ุฃูุถู**
   - ุงูููุฑุณ `orders_store_id_idx` ุณูุญุณู ุณุฑุนุฉ ุงูุจุญุซ

---

## ๐จ ููุงุญุธุงุช ูููุฉ

### ุฅุฐุง ูู ุชุทุจู Migration:
- โ **ุงูุชุทุจูู ุณูุนูู** - ูู ูุชุนุทู
- โ๏ธ **ููู**: ุฌููุน ุงูุทูุจุงุช ุณุชุธูุฑ ุฏุงุฆูุงูุ ุญุชู ุนูุฏ ุงุฎุชูุงุฑ ูุชุฌุฑ ูุนูู
- โ๏ธ **ุณูุธูุฑ ุชุญุฐูุฑ** ูู console: `"Column store_id does not exist in orders table, fetching all orders"`

### ุจุนุฏ ุชุทุจูู Migration:
- โ **ุชุตููุฉ ุฏูููุฉ** ููุทูุจุงุช ุญุณุจ ุงููุชุฌุฑ
- โ **ุฅุญุตุงุฆูุงุช ุตุญูุญุฉ** ููู ูุชุฌุฑ
- โ **ูุง ุชุญุฐูุฑุงุช** ูู console

---

## ๐ง ุญู ุงููุดุงูู

### ุงููุดููุฉ: "relation orders does not exist"
**ุงูุญู:** ุชุฃูุฏ ูู ุฃูู ููุช ุจุฅูุดุงุก ุฌุฏูู `orders` ุฃููุงู. ุฑุงุฌุน:
```
supabase/MERCHANT_DATABASE_SCHEMA.sql
```

### ุงููุดููุฉ: "constraint already exists"
**ุงูุญู:** ุงูุณูุฑูุจุช ูุณุชุฎุฏู `IF NOT EXISTS`ุ ููู ุฅุฐุง ุธูุฑุช ุงููุดููุฉ:
```sql
-- ุชุญูู ูู ุงููููุฏ ุงูููุฌูุฏุฉ
SELECT constraint_name 
FROM information_schema.table_constraints 
WHERE table_name = 'orders';
```

### ุงููุดููุฉ: "null value in column store_id"
**ุงูุญู:** ุงูุณูุฑูุจุช ูุญุฏุซ ุฌููุน ุงูุณุฌูุงุช ุชููุงุฆูุงู. ุฅุฐุง ุธูุฑุช ุงููุดููุฉ:
```sql
-- ุชุญุฏูุซ ูุฏูู
UPDATE orders 
SET store_id = (
  SELECT id FROM merchants 
  WHERE owner_id = orders.merchant_id 
  LIMIT 1
)
WHERE store_id IS NULL;
```

---

## ๐ ูููุณุชูุจู: ุฅุถุงูุฉ Migrations ุชููุงุฆูุงู

ุฅุฐุง ููุช ุชุณุชุฎุฏู Supabase CLI:

```bash
# ุฅูุดุงุก migration ุฌุฏูุฏ
supabase migration new add_store_id_to_orders

# ุชุทุจูู migrations
supabase db push

# ุงูุชุญูู ูู ุงูุญุงูุฉ
supabase migration list
```

---

## ๐ ูุนูููุงุช ุฅุถุงููุฉ

### ุจููุฉ ุฌุฏูู orders ุจุนุฏ Migration:

| ุงูุนููุฏ | ุงูููุน | ุงููุตู |
|--------|------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| merchant_id | UUID | ูุนุฑู ุงูุชุงุฌุฑ |
| **store_id** | **UUID** | **ูุนุฑู ุงููุชุฌุฑ (ุฌุฏูุฏ)** |
| customer_id | UUID | ูุนุฑู ุงูุนููู |
| status | TEXT | ุญุงูุฉ ุงูุทูุจ |
| total_amount | NUMERIC | ุฅุฌูุงูู ุงููุจูุบ |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅูุดุงุก |

### ุงูุนูุงูุงุช (Foreign Keys):

```
orders.merchant_id โ profiles.id
orders.store_id โ merchants.id  โ ุฌุฏูุฏ
orders.customer_id โ profiles.id
```

---

## โ Checklist

ูุจู ุฅุบูุงู ูุฐุง ุงูุฏูููุ ุชุฃูุฏ ูู:

- [ ] ุชุทุจูู SQL Script ูู Supabase Dashboard
- [ ] ุงูุชุญูู ูู ูุฌูุฏ ุนููุฏ `store_id` ูู ุฌุฏูู `orders`
- [ ] ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู (`npx expo start -c`)
- [ ] ุงุฎุชุจุงุฑ ุชุตููุฉ ุงูุทูุจุงุช ุญุณุจ ุงููุชุฌุฑ
- [ ] ุงูุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ุฃุฎุทุงุก ูู console

---

## ๐ ุงูุฏุนู

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงูู:
1. ุชุญูู ูู console logs
2. ุฑุงุฌุน Supabase Dashboard โ Database โ Tables โ orders
3. ุชุฃูุฏ ูู ุฃู RLS policies ุตุญูุญุฉ

**ููุงุญุธุฉ:** ุงูููุฏ ุงูุญุงูู ูุนูู ุจุฏูู Migrationุ ููู ูุฃูุถู ุฃุฏุงุก ูุชุฌุฑุจุฉ ูุณุชุฎุฏูุ ูููุตุญ ุจุชุทุจูู Migration.

# ๐ ุชุทุจูู OTP ูู ุงูุชุณุฌูู - OTP Implementation

**ุชุงุฑูุฎ ุงูุชูููุฐ:** 2025-10-26  
**ุงูุญุงูุฉ:** โ ููุชูู

---

## ๐ฏ ุงููุฏู

ุชุญููู ูุธุงู ุงูุชุณุฌูู ูู ุงุณุชุฎุฏุงู Email Link ุฅูู Email OTPุ ุจุญูุซ:
1. ุงููุณุชุฎุฏู ูุฏุฎู ุจูุงูุงุชู
2. ูุชู ุฅุฑุณุงู ุฑูุฒ ูููู ูู 6 ุฃุฑูุงู ููุฅูููู
3. ุงููุณุชุฎุฏู ูุฏุฎู ุงูุฑูุฒ ูู ููุณ ุงูุดุงุดุฉ
4. ุจุนุฏ ุงูุชุญูู ุงููุงุฌุญุ ูุชู ุฅูุดุงุก profile ูุงูุชูุฌูู

---

## โ ุงูุชุบููุฑุงุช ุงูููููุฐุฉ

### 1๏ธโฃ ุฅุถุงูุฉ ุญุงูุงุช ุฌุฏูุฏุฉ (State)

```typescript
// ุญุงูุฉ OTP
const [showOtpInput, setShowOtpInput] = useState(false);
const [otpCode, setOtpCode] = useState('');
const [tempUserData, setTempUserData] = useState<any>(null);
```

**ุงูุบุฑุถ:**
- `showOtpInput`: ููุชุญูู ูู ุฅุธูุงุฑ/ุฅุฎูุงุก ูุฑุจุน OTP
- `otpCode`: ูุญูุธ ุงูุฑูุฒ ุงูููุฏุฎู
- `tempUserData`: ูุญูุธ ุจูุงูุงุช ุงููุณุชุฎุฏู ูุคูุชุงู ุญุชู ุงูุชุญูู

---

### 2๏ธโฃ ุชุนุฏูู ุฏุงูุฉ signUp

**ูุจู:**
```typescript
// ูุงูุช ุชูุดุฆ profile ูุจุงุดุฑุฉ
if (data.user) {
  await supabase.from('profiles').upsert({...});
}
// ุซู ุชูุฌู ุงููุณุชุฎุฏู
router.replace('/auth/complete-profile');
```

**ุจุนุฏ:**
```typescript
// ุญูุธ ุงูุจูุงูุงุช ูุคูุชุงู
setTempUserData({
  userId: data.user?.id,
  fullName: fullName.trim(),
  formattedPhone,
  userType,
});

// ุฅุธูุงุฑ ูุฑุจุน OTP
setShowOtpInput(true);
setLoading(false);
```

**ุงูุณุจุจ:**
- โ **ุงููุดููุฉ:** ุฅูุดุงุก profile ูุจู ุงูุชุญูู ููุดู ุจุณุจุจ RLS Policy
- โ **ุงูุญู:** ุญูุธ ุงูุจูุงูุงุช ูุฅูุดุงุก profile ุจุนุฏ ุงูุชุญูู ููุท

---

### 3๏ธโฃ ุฅุถุงูุฉ ุฏุงูุฉ verifyOtp

```typescript
const verifyOtp = async () => {
  // 1. ุงูุชุญูู ูู ุทูู ุงูุฑูุฒ
  if (!otpCode || otpCode.length !== 6) {
    Alert.alert('ุฎุทุฃ', 'ูุฑุฌู ุฅุฏุฎุงู ุฑูุฒ ุงูุชุญูู ุงููููู ูู 6 ุฃุฑูุงู');
    return;
  }

  // 2. ุงูุชุญูู ูู OTP
  const { data, error } = await supabase.auth.verifyOtp({
    email: email.trim(),
    token: otpCode,
    type: 'signup',
  });

  // 3. ุฅูุดุงุก profile ุจุนุฏ ุงูุชุญูู ุงููุงุฌุญ
  if (data.user && tempUserData) {
    await supabase.from('profiles').insert({
      id: data.user.id,
      full_name: tempUserData.fullName,
      phone_number: tempUserData.formattedPhone || null,
      user_type: tempUserData.userType,
      is_active: true,
      created_at: new Date().toISOString(),
    });
  }

  // 4. ุฑุณุงูุฉ ุชุฑุญูุจ ูุชูุฌูู
  Alert.alert('ุชู ุงูุชุญูู ุจูุฌุงุญ! ๐', welcomeMessage);
  router.replace('/auth/complete-profile');
};
```

**ุงูููุงุฆุฏ:**
- โ ุงููุณุชุฎุฏู ุงูุขู ููุณุฌู ุฏุฎูู (ุจุนุฏ verifyOtp)
- โ RLS Policy ุชุณูุญ ุจุฅูุดุงุก profile
- โ ูุง ุฃุฎุทุงุก ูู Console

---

### 4๏ธโฃ ุฅุถุงูุฉ ุฏุงูุฉ resendOtp

```typescript
const resendOtp = async () => {
  const { error } = await supabase.auth.resend({
    type: 'signup',
    email: email.trim(),
  });

  if (!error) {
    Alert.alert('ุชู ุงูุฅุฑุณุงู', 'ุชู ุฅุนุงุฏุฉ ุฅุฑุณุงู ุฑูุฒ ุงูุชุญูู');
  }
};
```

**ุงููุงุฆุฏุฉ:**
- โ ุฅุฐุง ูู ูุตู ุงูุฑูุฒุ ูููู ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู

---

### 5๏ธโฃ ุฅุถุงูุฉ UI ููุฑุจุน OTP

```tsx
{showOtpInput && (
  <View style={styles.otpContainer}>
    <Text style={styles.otpTitle}>ุฑูุฒ ุงูุชุญูู</Text>
    <Text style={styles.otpSubtitle}>
      ุชู ุฅุฑุณุงู ุฑูุฒ ูููู ูู 6 ุฃุฑูุงู ุฅูู {email}
    </Text>
    
    <TextInput
      placeholder="123456"
      value={otpCode}
      onChangeText={setOtpCode}
      keyboardType="number-pad"
      maxLength={6}
      autoFocus
    />
    
    <TouchableOpacity onPress={verifyOtp}>
      <Text>ุชุญูู</Text>
    </TouchableOpacity>
    
    <TouchableOpacity onPress={resendOtp}>
      <Text>ุฅุนุงุฏุฉ ุฅุฑุณุงู ุงูุฑูุฒ</Text>
    </TouchableOpacity>
  </View>
)}

{/* ุฒุฑ ุฅูุดุงุก ุงูุญุณุงุจ ูุธูุฑ ููุท ูุจู OTP */}
{!showOtpInput && (
  <TouchableOpacity onPress={signUp}>
    <Text>ุฅูุดุงุก ุญุณุงุจ</Text>
  </TouchableOpacity>
)}
```

**ุงูููุฒุงุช:**
- ๐ฑ ูุฑุจุน ุฅุฏุฎุงู ุฑููู (keyboardType="number-pad")
- ๐ข ูุญุฏูุฏ ุจู 6 ุฃุฑูุงู (maxLength={6})
- โก ุชุฑููุฒ ุชููุงุฆู (autoFocus)
- ๐ ุฒุฑ ุฅุนุงุฏุฉ ุฅุฑุณุงู

---

## ๐ฏ ุชุฏูู ุงูุชุณุฌูู ุงูุฌุฏูุฏ

```
1. ุงููุณุชุฎุฏู ูููุฃ ุงูุจูุงูุงุช
   โโ ุงูุงุณู
   โโ ุงูุฅูููู
   โโ ุงููุงุชู (ุงุฎุชูุงุฑู)
   โโ ูููุฉ ุงููุฑูุฑ
   โโ ููุน ุงูุญุณุงุจ (ุนููู/ุชุงุฌุฑ/ุณุงุฆู)
   โ
2. ูุถุบุท "ุฅูุดุงุก ุญุณุงุจ"
   โ
3. Supabase ูุฑุณู OTP ููุฅูููู โ๏ธ
   โโ ุฑูุฒ ูููู ูู 6 ุฃุฑูุงู
   โโ ุตุงูุญ ููุฏุฉ ูุญุฏูุฏุฉ
   โ
4. ูุธูุฑ ูุฑุจุน ุฅุฏุฎุงู OTP ๐ฑ
   โโ autoFocus ุชููุงุฆู
   โโ keyboardType ุฑููู
   โโ maxLength: 6
   โ
5. ุงููุณุชุฎุฏู ูุฏุฎู ุงูุฑูุฒ
   โ
6. ูุถุบุท "ุชุญูู"
   โ
7. Supabase ูุชุญูู ูู ุงูุฑูุฒ โ
   โโ ุฅุฐุง ุตุญูุญ โ ุชุณุฌูู ุฏุฎูู ุชููุงุฆู
   โโ ุฅุฐุง ุฎุงุทุฆ โ ุฑุณุงูุฉ ุฎุทุฃ
   โ
8. ุฅูุดุงุก profile ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
   โโ full_name
   โโ phone_number
   โโ user_type
   โโ is_active: true
   โ
9. ุฑุณุงูุฉ ุชุฑุญูุจ ูุฎุตุตุฉ ๐
   โ
10. ุงูุชูุฌูู ุญุณุจ ููุน ุงููุณุชุฎุฏู:
    โโ ุนููู โ /auth/complete-profile
    โโ ุชุงุฌุฑ โ /auth/setup-merchant
    โโ ุณุงุฆู โ /auth/setup-driver
```

---

## ๐ ุงููุดุงูู ุงูููุญููุฉ

### ุงููุดููุฉ 1: RLS Policy Error โ
**ุงูุฎุทุฃ:**
```
new row violates row-level security policy for table "profiles"
```

**ุงูุณุจุจ:**
- ููุง ููุดุฆ profile ูุจู ุชุณุฌูู ุงูุฏุฎูู
- RLS Policy ุชุฑูุถ ุงูุฅุฏุฎุงู ูู ูุณุชุฎุฏู ุบูุฑ ูุณุฌู ุฏุฎูู

**ุงูุญู:** โ
- ุฅูุดุงุก profile ุจุนุฏ `verifyOtp` ููุท
- ุนูุฏูุง ุงููุณุชุฎุฏู ูููู ูุณุฌู ุฏุฎูู

---

### ุงููุดููุฉ 2: ุชุฎุทู ุดุงุดุฉ OTP โ
**ุงููุตู:**
- ุงููุณุชุฎุฏู ูููุฌูู ูุจุงุดุฑุฉ ูู complete-profile
- ูุง ูุธูุฑ ูุฑุจุน ุฅุฏุฎุงู OTP

**ุงูุณุจุจ:**
- ุงูููุฏ ุงููุฏูู ูุงู ูููุฌูู ููุฑุงู ุจุนุฏ signUp

**ุงูุญู:** โ
- ุงุณุชุฎุฏุงู `showOtpInput` ููุชุญูู ูู ุงูุนุฑุถ
- ุนุฑุถ ูุฑุจุน OTP ุจุฏูุงู ูู ุงูุชูุฌูู
- ุงูุชูุฌูู ููุท ุจุนุฏ `verifyOtp` ุงููุงุฌุญ

---

### ุงููุดููุฉ 3: ุฑูู ุงููุงุชู ูุง ููุญูุธ โ
**ุงูุณุจุจ:**
- ูุงู ููุญูุธ ูู `phone` ุจุฏูุงู ูู `phone_number`

**ุงูุญู:** โ
- ุงุณุชุฎุฏุงู `phone_number` (ุงุณู ุงูุนููุฏ ุงูุตุญูุญ)
- ุชู ุฅุตูุงุญู ุณุงุจูุงู

---

## ๐ ุงููุฑููุงุช: Email Link vs Email OTP

| ุงูููุฒุฉ | Email Link (ุงููุฏูู) | Email OTP (ุงูุฌุฏูุฏ) |
|--------|---------------------|---------------------|
| ุทุฑููุฉ ุงูุชุญูู | ุฑุงุจุท ูู ุงูุฅูููู | ุฑูุฒ 6 ุฃุฑูุงู |
| ุงูุฎุทูุงุช | 3 ุฎุทูุงุช | ุฎุทูุชุงู |
| ุณุฑุนุฉ | ุจุทูุก (ูุชุญ ุฅูููู + ุถุบุท ุฑุงุจุท) | ุณุฑูุน (ูุณุฎ ุฑูุฒ) |
| UX | ูุชุทูุจ ูุบุงุฏุฑุฉ ุงูุชุทุจูู | ูู ุดูุก ูู ุงูุชุทุจูู |
| ุงูุฌูุงู | ุตุนุจ (ุชุจุฏูู ุชุทุจููุงุช) | ุณูู ุฌุฏุงู |
| ุงูุงูุชุธุงุฑ | ุทููู | ูุตูุฑ |
| ุงูุชุญูู | ุชููุงุฆู ุนูุฏ ุงูุถุบุท | ูุฏูู (ุฅุฏุฎุงู ุฑูุฒ) |

---

## โ๏ธ ุฅุนุฏุงุฏุงุช Supabase ุงููุทููุจุฉ

### 1. ุชูุนูู Email OTP

ูู Supabase Dashboard:
```
Authentication โ Email Templates โ Confirm signup
```

ุชุฃูุฏ ูู ูุฌูุฏ Template ูุฑุณู OTP.

### 2. OTP Settings

```
Authentication โ Settings โ Auth
```

- โ Enable Email OTP
- โฑ๏ธ OTP Expiry: 60 ุฏูููุฉ (ุงูุชุฑุงุถู)
- ๐ข OTP Length: 6 ุฃุฑูุงู

---

## ๐งช ุงุฎุชุจุงุฑ ุงููุธุงู

### ุณููุงุฑูู 1: ุชุณุฌูู ูุงุฌุญ โ
```
1. ุงููุฃ ุฌููุน ุงูุญููู
2. ุงุถุบุท "ุฅูุดุงุก ุญุณุงุจ"
3. ุชุญูู ูู ุงูุฅูููู
4. ุงูุณุฎ ุงูุฑูุฒ (6 ุฃุฑูุงู)
5. ุงูุตูู ูู ูุฑุจุน OTP
6. ุงุถุบุท "ุชุญูู"
7. ูุฌุจ ุฃู ุชุธูุฑ ุฑุณุงูุฉ ูุฌุงุญ
8. ูุชู ุงูุชูุฌูู ุญุณุจ ููุน ุงูุญุณุงุจ
```

### ุณููุงุฑูู 2: OTP ุฎุงุทุฆ โ
```
1-5. ููุณ ุงูุฎุทูุงุช
6. ุฃุฏุฎู ุฑูุฒ ุฎุงุทุฆ
7. ุงุถุบุท "ุชุญูู"
8. ูุฌุจ ุฃู ุชุธูุฑ: "ุฑูุฒ ุงูุชุญูู ุบูุฑ ุตุญูุญ"
```

### ุณููุงุฑูู 3: ุฅุนุงุฏุฉ ุฅุฑุณุงู โ๏ธ
```
1-3. ููุณ ุงูุฎุทูุงุช
4. ุงูุชุธุฑ 30 ุซุงููุฉ
5. ุงุถุบุท "ุฅุนุงุฏุฉ ุฅุฑุณุงู ุงูุฑูุฒ"
6. ุชุญูู ูู ุงูุฅูููู ูุฑุฉ ุฃุฎุฑู
7. ุงุณุชุฎุฏู ุงูุฑูุฒ ุงูุฌุฏูุฏ
```

---

## โ ุงูุฎูุงุตุฉ

**ุชู ุฅููุงู ุชุทุจูู OTP ุจูุฌุงุญ! ๐**

ุงูุขู:
- โ ุงููุณุชุฎุฏู ูุฏุฎู OTP ูู ููุณ ุงูุดุงุดุฉ
- โ ูุง ุญุงุฌุฉ ููุฐูุงุจ ููุฅูููู ูุงูุถุบุท ุนูู ุฑุงุจุท
- โ ุชุฌุฑุจุฉ ุฃุณุฑุน ูุฃุณูู
- โ ูุง ุฃุฎุทุงุก RLS
- โ ุฑูู ุงููุงุชู ููุญูุธ ุตุญูุญ
- โ ุฌุงูุฒ ููุงุณุชุฎุฏุงู ุงููุนูู!

---

**ุชุงุฑูุฎ ุงูุฅูุฌุงุฒ:** 2025-10-26  
**ุงููุทูุฑ:** Cascade AI  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุฅูุชุงุฌ
